From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Martijn Muijsers <martijnmuijsers@live.nl>
Date: Sun, 25 Dec 2022 23:39:05 +0100
Subject: [PATCH] Ignore null legacy structure data

License: GPL-3.0 (https://www.gnu.org/licenses/gpl-3.0.html)
Gale - https://galemc.org

This patch is based on the following patch:
"Add null check in LegacyStructureDataHandler"
By: PureGero <puregero@gmail.com>
As part of: MultiPaper (https://github.com/MultiPaper/MultiPaper)
Licensed under: GPL-3.0 (https://www.gnu.org/licenses/gpl-3.0.html)

diff --git a/src/main/java/net/minecraft/world/level/levelgen/structure/LegacyStructureDataHandler.java b/src/main/java/net/minecraft/world/level/levelgen/structure/LegacyStructureDataHandler.java
index 12ec1def8a100aa8400f9ef183b5ef744e2b11aa..9e44bb3d5553392ffcda4ecb81a2eb0fdfa71d48 100644
--- a/src/main/java/net/minecraft/world/level/levelgen/structure/LegacyStructureDataHandler.java
+++ b/src/main/java/net/minecraft/world/level/levelgen/structure/LegacyStructureDataHandler.java
@@ -171,6 +171,7 @@ public class LegacyStructureDataHandler {
 
     private void populateCaches(@Nullable DimensionDataStorage persistentStateManager) {
         if (persistentStateManager != null) {
+            boolean ignoreNullLegacyStructureData = org.galemc.gale.configuration.GaleGlobalConfiguration.get().misc.ignoreNullLegacyStructureData; // Gale - MultiPaper - ignore null legacy structure data
             Iterator iterator = this.legacyKeys.iterator();
 
             while (iterator.hasNext()) {
@@ -178,7 +179,11 @@ public class LegacyStructureDataHandler {
                 CompoundTag nbttagcompound = new CompoundTag();
 
                 try {
-                    nbttagcompound = persistentStateManager.readTagFromDisk(s, DataFixTypes.SAVED_DATA_STRUCTURE_FEATURE_INDICES, 1493).getCompound("data").getCompound("Features");
+                    // Gale start - MultiPaper - ignore null legacy structure data
+                    CompoundTag tag = persistentStateManager.readTagFromDisk(s, DataFixTypes.SAVED_DATA_STRUCTURE_FEATURE_INDICES, 1493);
+                    if (ignoreNullLegacyStructureData && tag == null) continue;
+                    nbttagcompound = tag.getCompound("data").getCompound("Features");
+                    // Gale end - MultiPaper - ignore null legacy structure data
                     if (nbttagcompound.isEmpty()) {
                         continue;
                     }
diff --git a/src/main/java/org/galemc/gale/configuration/GaleGlobalConfiguration.java b/src/main/java/org/galemc/gale/configuration/GaleGlobalConfiguration.java
index c9f19aa7dbf01d6dd295ae9e8d3df06c16ef75b4..16e7e370385fc4c43c1bbac1a5d9c504ffd8877c 100644
--- a/src/main/java/org/galemc/gale/configuration/GaleGlobalConfiguration.java
+++ b/src/main/java/org/galemc/gale/configuration/GaleGlobalConfiguration.java
@@ -53,6 +53,7 @@ public class GaleGlobalConfiguration extends ConfigurationPart {
 
         public boolean verifyChatOrder = true; // Gale - Pufferfish - make chat order verification configurable
         public int premiumAccountSlowLoginTimeout = -1; // Gale - make slow login timeout configurable
+        public boolean ignoreNullLegacyStructureData = false; // Gale - MultiPaper - ignore null legacy structure data
 
         public Keepalive keepalive;
         public class Keepalive extends ConfigurationPart {
