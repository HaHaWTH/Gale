From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Martijn Muijsers <martijnmuijsers@live.nl>
Date: Wed, 30 Nov 2022 15:51:59 +0100
Subject: [PATCH] Cache BlockStatePairKey hash

License: LGPL-3.0 (https://www.gnu.org/licenses/lgpl-3.0.html)
Gale - https://galemc.org

This patch is based on the following mixin:
"net/caffeinemc/mods/lithium/mixin/cached_hashcode/FlowingFluid$BlockStatePairKeyMixin.java"
By: Angeline <jellysquid3@users.noreply.github.com>
As part of: Lithium (https://github.com/CaffeineMC/lithium-fabric)
Licensed under: LGPL-3.0 (https://www.gnu.org/licenses/lgpl-3.0.html)

diff --git a/src/main/java/net/minecraft/world/level/material/FlowingFluid.java b/src/main/java/net/minecraft/world/level/material/FlowingFluid.java
index f4fbcbb8ff6d2677af1a02a0801a323c06dce9b1..221978c64cf6171db078c6cbfc850f6aeae73884 100644
--- a/src/main/java/net/minecraft/world/level/material/FlowingFluid.java
+++ b/src/main/java/net/minecraft/world/level/material/FlowingFluid.java
@@ -577,8 +577,27 @@ public abstract class FlowingFluid extends Fluid {
         });
     }
 
-    private static record BlockStatePairKey(BlockState first, BlockState second, Direction direction) {
+    // Gale start - Lithium - cache BlockStatePairKey hash
+    private static class BlockStatePairKey {
+
+        private final BlockState first;
+        private final BlockState second;
+        private final Direction direction;
+        private final int hash;
+
+        private BlockStatePairKey(BlockState first, BlockState second, Direction direction) {
+            this.first = first;
+            this.second = second;
+            this.direction = direction;
+            int hash = System.identityHashCode(this.first);
+
+            hash = 31 * hash + System.identityHashCode(this.second);
+            hash = 31 * hash + this.direction.hashCode();
+            this.hash = hash;
+        }
 
+        @Override
+        // Gale end - Lithium - cache BlockStatePairKey hash
         public boolean equals(Object object) {
             boolean flag;
 
@@ -593,12 +612,9 @@ public abstract class FlowingFluid extends Fluid {
             return flag;
         }
 
+        @Override // Gale - Lithium - cache BlockStatePairKey hash
         public int hashCode() {
-            int i = System.identityHashCode(this.first);
-
-            i = 31 * i + System.identityHashCode(this.second);
-            i = 31 * i + this.direction.hashCode();
-            return i;
+            return this.hash; // Gale - Lithium - cache BlockStatePairKey hash
         }
     }
 
