From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Martijn Muijsers <martijnmuijsers@live.nl>
Date: Wed, 23 Nov 2022 16:29:01 +0100
Subject: [PATCH] Predict Halloween

License: GPL-3.0 (https://www.gnu.org/licenses/gpl-3.0.html)
Gale - https://galemc.org

diff --git a/src/main/java/net/minecraft/world/entity/ambient/Bat.java b/src/main/java/net/minecraft/world/entity/ambient/Bat.java
index 60c2868f255d372226e0c1389caaa5477bbef41e..05ab901becfc7ffe4e4483ac2c7acb2e2a72490f 100644
--- a/src/main/java/net/minecraft/world/entity/ambient/Bat.java
+++ b/src/main/java/net/minecraft/world/entity/ambient/Bat.java
@@ -242,12 +242,66 @@ public class Bat extends AmbientCreature {
         }
     }
 
+    // Gale start - predict Halloween
+    /**
+     * The 1-indexed month of the year that Halloween starts (inclusive).
+     */
+    private static final int halloweenStartMonthOfYear = 10;
+
+    /**
+     * The 1-indexed day of the month that Halloween starts (inclusive).
+     */
+    private static final int halloweenStartDayOfMonth = 20;
+
+    /**
+     * The 1-indexed month of the year that Halloween ends (exclusive).
+     */
+    private static final int halloweenEndMonthOfYear = 11;
+
+    /**
+     * The 1-indexed day of the month that Halloween ends (exclusive).
+     */
+    private static final int halloweenEndDayOfMonth = 4;
+
+    /**
+     * The next start of Halloween, given as milliseconds since the Unix epoch.
+     * Will be 0 while not computed yet.
+     */
+    private static long nextHalloweenStart = 0;
+
+    /**
+     * The next end of Halloween, given as milliseconds since the Unix epoch.
+     * Will be 0 while not computed yet.
+     */
+    private static long nextHalloweenEnd = 0;
+
+    // The Halloween begins at 10/20 0:00, and end with 11/04 0:00
+    // Only when the current Halloween period ends, the `nextHalloweenStart`
+    // and `nextHalloweenEnd` will adjust to the epoch ms of date of next year
+    // These two fields will not change during current Halloween period.
     private static boolean isHalloween() {
-        LocalDate localdate = LocalDate.now();
-        int i = localdate.get(ChronoField.DAY_OF_MONTH);
-        int j = localdate.get(ChronoField.MONTH_OF_YEAR);
+        long currentEpochMillis = System.currentTimeMillis();
 
-        return j == 10 && i >= 20 || j == 11 && i <= 3;
+        if (currentEpochMillis > nextHalloweenEnd) {
+            // Update prediction
+
+            java.time.OffsetDateTime currentDate = java.time.OffsetDateTime.now();
+            int currentMonthOfYear = currentDate.getMonth().getValue();
+            int currentDayOfMonth = currentDate.getDayOfMonth();
+
+            java.time.OffsetDateTime nextHalloweenStartDate = currentDate.withMonth(halloweenStartMonthOfYear).withDayOfMonth(halloweenStartDayOfMonth)
+                .withHour(0).withMinute(0).withSecond(0).withNano(0); // Adjust to directly start or end at zero o'clock
+
+            if (currentMonthOfYear >= halloweenEndMonthOfYear && currentDayOfMonth >= halloweenEndDayOfMonth) {
+                nextHalloweenStartDate = nextHalloweenStartDate.plusYears(1);
+            }
+
+            nextHalloweenStart = nextHalloweenStartDate.toInstant().toEpochMilli();
+            nextHalloweenEnd = nextHalloweenStartDate.withMonth(halloweenEndMonthOfYear).withDayOfMonth(halloweenEndDayOfMonth).toInstant().toEpochMilli();
+        }
+
+        return currentEpochMillis >= nextHalloweenStart;
+        // Gale end - predict Halloween
     }
 
     private void setupAnimationStates() {
